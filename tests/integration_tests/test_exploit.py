import requests
from pystarport import ports

from .utils import CONTRACTS, deploy_contract


def test_batch(ethermint):
    w3 = ethermint.w3
    _, res = deploy_contract(w3, CONTRACTS["TestExploitContract"])
    params = []
    param = {
        "jsonrpc": "2.0",
        "method": "eth_call",
        "params": [{
            "data": "0x5e67164c",
            "to": res["contractAddress"],
        }, "latest"],
        "id": 1,
    }
    for _ in range(0, 10):
        params.append(param)
    url = f"http://127.0.0.1:{ports.evmrpc_port(ethermint.base_port(0))}"
    rsp = requests.post(url, json=params)
    assert len(rsp.json()) > 0
