from concurrent.futures import ThreadPoolExecutor

import requests
from pystarport import ports

from .utils import CONTRACTS, deploy_contract


def assert_call(port, params):
    url = f"http://127.0.0.1:{ports.evmrpc_port(port)}"
    rsp = requests.post(url, json=params)
    assert rsp.status_code == 200


def test_call(ethermint):
    _, res = deploy_contract(ethermint.w3, CONTRACTS["TestExploitContract"])
    param = {
        "jsonrpc": "2.0",
        "method": "eth_call",
        "params": [{
            "data": "0x5e67164c",
            "to": res["contractAddress"],
        }, "latest"],
        "id": 1,
    }
    params = [param]
    limit = 10
    for is_concurrent in [True, False]:
        if is_concurrent:
            with ThreadPoolExecutor(limit) as executor:
                for _ in range(1, limit):
                    executor.submit(assert_call, ethermint.base_port(0), params)
        else:
            for _ in range(1, limit):
                params.append(param)
            assert_call(ethermint.base_port(0), params)
